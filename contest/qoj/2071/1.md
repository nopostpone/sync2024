# The 3rd Universal Cup. Stage 39: Tokyo 补题

[补题链接](https://qoj.ac/contest/2071)。

## A. Array Similarity

> 太久没写倍增，忘完了，这里写详细一点，帮自己巩固一下。

设 $f(i)$ 为最小的满足 $j>i$ 且 $a_j>a_i$ 的 $j$，初始值为正无穷。这个可以单调栈扫过去求。

对于 $[l, r]$，有多少个位置是前缀最大呢？是 $l,f(l),f(f(l)),\dots$ 反复嵌套下去，直到大于 $r$ 停下。

对于两个区间，我们怎么判断它们前缀最大值的位置都相同呢？仅需要做差分即可，也就是检查 $\{l_1 - f(l_1), f(l_1) - f[f(l_1)],\dots\}$ 与 $\{l_2 - f(l_2), f(l_2) - f[f(l_2)],\dots\}$ 是否相等。

首先想到哈希，将数组做一个哈希，比较哈希值即可。

其次，这类一直重复往后跳（即取 $i = f(i)$）的过程，可以用倍增进行优化。于是我们设 $f(i, j)$ 为 $i$ 往后跳 $2^j$ 次的位置。初始 $f(i, 0)$ 与原先定义的 $f(i)$ 相同。

设 $g(i, j)$ 表示 $i$ 往后跳了 $2^j$ 的过程中，这个数组的哈希值。初始有 $g(i, 0) = f(i, 0) - i$。转移为

$$
f(i, j + 1)\leftarrow f[f(i, j), j]\\
g(i, j + 1)\leftarrow B^{2^j} g(i, j) + g[f(i, j), j]
$$

$f$ 的转移是很显然的，而 $g$ 稍微有点绕，右式第一项为前 $2^j$ 次跳，前 $2^j$ 次跳完，跳到了 $f(i, j)$ 的位置，然后进行后 $2^j$ 次跳。

对于 $[l, r]$，枚举 $j$ 从 $\log n$ 到 $0$，当 $f(l, j)$ 没跳出去，那么进行跳跃即可。

复杂度 $\mathcal O((n+q)\log n)$。

[代码](https://qoj.ac/submission/1662287)。

## B. Bracket Character Frequency

考察对合法括号串的理解，发现性质就很好做。

一个长为 $2k$ 的合法括号串，首先 `(` 的数量肯定等于 `)` 的数量，即 `(` 的数量恰好为 $k$。

其次，不能有括不上的情况。比如第一个位置一定要是 `(`，第二、三位置至少有一个 `(`，可以归结为 $2i-1$ 个位置中，至少有 $i$ 个 `(`。

接下来就很明朗了，只需要检查 $a$ 是否满足：

- $\sum_{i=1}^{2k} a_i = nk$
- $\forall i \leq k$，$\sum_{j=1}^{2i-1}a_j \geq ni$

我的心得是对于这些检验是否合法的题目，一定要多把玩一下给的东西，有哪些性质，或者推论，事半功倍。

## M. Minimum Distance Tree

显然，如果存在这样一棵树，那么必定是这张图的最小生成树。于是把最小生成树做出来，再检查剩余边 $(u, v, w)$ 是否满足 $dis(u, v) \geq w$ 即可。复杂度 $\mathcal O(n\log n)$。

## Q. Quadratic Pieces

一个定理：数列 $a_n$ 是一个 $p$ 阶等差数列的充要条件为，数列的通项 $a_n$ 为 $n$ 的一个 $p$ 次多项式。

证明有点复杂的，这里略。

这题，我们希望序列是平方的，那就转化为，序列是一个二阶的等差数列，即三阶差分为 $0$，即

$$
\begin{align*}
\Delta^3 a_n &= \Delta(\Delta(\Delta a_n)) \\
&= \Delta(\Delta(a_n - a_{n-1}))\\
&= a_n - 3a_{n-1} + 3a_{n-2} - a_{n-3}\\
&= 0
\end{align*}
$$

双指针扫过去，贪心地取。

不知道高阶差分或者这个定理的话，这题也能做的，就是麻烦一些。推出 $ux^2+vx+w$ 中的 $u$ 和 $v$ 关于左端点 $l$ 的表达式，然后向右贪心地取即可，都是双指针。